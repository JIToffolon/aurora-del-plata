---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { reader } from "../../lib/keystatic";
import { resolveKeystaticAsset } from "../../lib/keystaticAssets";
import { Image } from "astro:assets";

const q = (Astro.url.searchParams.get("q") ?? "").trim().toLowerCase();
const category = (Astro.url.searchParams.get("category") ?? "all").trim().toLowerCase();

const all = await reader.collections.posts.all();

const items = all.map(({ slug, entry }) => ({
  slug,
  title: entry.title,
  excerpt: entry.excerpt ?? "",
  category: entry.category,
  date: entry.date ? new Date(entry.date) : null,
  coverImage: entry.coverImage ?? null,
}));

const filtered = items.filter((p) => {
  const catOk = category === "all" ? true : p.category === category;
  const qOk = !q
    ? true
    : p.title.toLowerCase().includes(q) || p.excerpt.toLowerCase().includes(q);

  return catOk && qOk;
});
---

<BaseLayout
  title="Blog / Novedades"
  description="Novedades, artÃ­culos y recursos sobre cannabis medicinal."
>
  <section class="space-y-6">
    <!-- header + form igual -->

    <div class="text-sm text-white/70">
      Mostrando <b class="text-white">{filtered.length}</b> de <b class="text-white">{items.length}</b>
    </div>

    <div class="grid gap-3 md:grid-cols-2">
      {
        filtered.length === 0 ? (
          <div class="md:col-span-2 rounded-2xl bg-white/5 p-4 ring-1 ring-white/10 text-sm text-white/70">
            No hay posts que coincidan.
          </div>
        ) : (
          filtered.map((p) => {
            const cover = resolveKeystaticAsset(p.coverImage);

            return (
              <a
                href={`/blog/${p.slug}`}
                class="block rounded-2xl bg-white/5 p-5 ring-1 ring-white/10 hover:bg-white/10 transition"
              >
                {cover && (
                  <Image
                    src={cover}
                    alt={`Portada: ${p.title}`}
                    class="mb-3 aspect-[16/9] w-full rounded-xl object-cover ring-1 ring-white/10"
                    loading="lazy"
                    decoding="async"
                    sizes="(min-width: 768px) 40vw, 100vw"
                  />
                )}

                <div class="flex flex-wrap gap-3 text-sm text-white/70">
                  <span class="rounded-full bg-white/10 px-3 py-1 ring-1 ring-white/10">
                    {p.category}
                  </span>
                  {p.date ? <span>{p.date.toLocaleDateString()}</span> : null}
                </div>

                <h2 class="mt-2 text-lg font-semibold">{p.title}</h2>

                {p.excerpt ? <p class="mt-2 text-sm text-white/70">{p.excerpt}</p> : null}
              </a>
            );
          })
        )
      }
    </div>
  </section>
</BaseLayout>
